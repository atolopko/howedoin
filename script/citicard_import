#!/usr/bin/env rails runner

opts = Trollop.options do
  opt :balance, "Statement ending balance", short: 'b', required: true
  opt :date, "Statement date", short: 'd', type: :string, required: true
end

begin
  Account.transaction do
    account = Account.where("name like 'Citibank MasterCard%'").last!
    statement = account.statements.create!(stmt_date: options.date, balance: options.balance)
    importer = Service::CiticardImporter.new(ARGF, statement)
    importer.import
    if importer.errors?
      STDERR.puts "Found #{importer.errors.size} errors during import:\n"
      STDERR.puts importer.format_errors
      STDERR.puts "Imported #{importer.imported.size} transactions"
      raise ActiveRecord::Rollback
    end
    puts("Imported #{importer.imported.size} transactions")
  end
rescue StandardError => e
  ap e
end
